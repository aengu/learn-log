{% extends 'base.html' %}

{% block title %}Learn Log - AI 개발 지식 베이스{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-sm">
        <div class="flex-1">
            <a class="btn btn-ghost text-xl">Learn Log</a>
        </div>
        <div class="flex-none">
            <span class="text-sm text-base-content/60">AI 기반 개발 지식 아카이브</span>
        </div>
    </div>

    <!-- Main Content --> 
    <main class="flex-1 container mx-auto max-w-4xl px-4 py-8">
        <!-- Search Form Card -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h2 class="card-title text-lg">개발 관련 질문을 입력하세요</h2>
                <form id="query-form">
                    {% csrf_token %}
                    <div class="join w-full mt-2">
                        <input
                            type="text"
                            name="query"
                            id="query-input"
                            placeholder="예: docker bridge network와 host network 차이"
                            class="input input-bordered join-item flex-1"
                            required
                            minlength="5"
                        />
                        <button type="submit" id="submit-btn" class="btn btn-primary join-item">
                            검색
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Container (숨김) -->
        <div id="progress-container" class="hidden mb-8">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center gap-4 mb-4">
                        <span class="loading loading-spinner loading-md text-primary"></span>
                        <span id="progress-message" class="text-sm">처리 중...</span>
                    </div>
                    <progress id="progress-bar" class="progress progress-primary w-full" value="0" max="5"></progress>
                    <div class="flex justify-between text-xs text-base-content/60 mt-1">
                        <span>진행률</span>
                        <span id="progress-percent">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Container -->
        <div id="result-container">
            <!-- 결과가 여기에 삽입됨 -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t">
        <aside>
            <p>Learn Log - 개발자의 학습을 기록하다</p>
        </aside>
    </footer>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('query-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const query = document.getElementById('query-input').value.trim();
    if (query.length < 5) {
        alert('질문은 최소 5자 이상이어야 합니다.');
        return;
    }

    const submitBtn = document.getElementById('submit-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressMessage = document.getElementById('progress-message');
    const progressPercent = document.getElementById('progress-percent');
    const resultContainer = document.getElementById('result-container');

    // UI 초기화
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> 처리 중';
    progressContainer.classList.remove('hidden');
    progressBar.value = 0;
    progressPercent.textContent = '0%';
    progressMessage.textContent = '처리 시작...';
    resultContainer.innerHTML = '';

    // FormData 생성
    const formData = new FormData();
    formData.append('query', query);

    // SSE fetch 스트리밍 처리
    fetch('{% url "search:query_api_stream" %}', {
        method: 'POST',
        body: formData,
    }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '검색';
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // 마지막 불완전한 라인은 버퍼에 유지

                for (const line of lines) {
                    if (line.startsWith('event:')) {
                        const eventType = line.slice(7).trim();
                        continue;
                    }
                    if (line.startsWith('data:')) {
                        const data = JSON.parse(line.slice(5).trim());

                        if (data.step !== undefined) {
                            // progress 이벤트
                            progressBar.value = data.step;
                            progressPercent.textContent = Math.round((data.step / data.total) * 100) + '%';
                            progressMessage.textContent = data.message;
                        } else if (data.html !== undefined) {
                            // complete 또는 error 이벤트
                            progressContainer.classList.add('hidden');
                            resultContainer.innerHTML = data.html;
                            
                            // 마크다운 렌더링 실행 (result.html의 스크립트가 실행됨)
                            const scripts = resultContainer.querySelectorAll('script');
                            scripts.forEach(script => {
                                const newScript = document.createElement('script');
                                newScript.textContent = script.textContent;
                                script.parentNode.replaceChild(newScript, script);
                            });
                        }
                    }
                }

                processStream(); // 재귀 호출
            });
        }

        processStream();
    });

});
</script>
{% endblock %}